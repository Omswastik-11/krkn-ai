name: Create Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    permissions:
      contents: write
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Calculate previous tag
        run: |
          git fetch --tags origin
          PREVIOUS_TAG=$(git tag --sort=-creatordate | sed -n '2 p')
          echo "PREVIOUS_TAG=${PREVIOUS_TAG}" >> "$GITHUB_ENV"

      - name: Generate release notes
        id: release-notes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ -z "${{ env.PREVIOUS_TAG }}" ]; then
            NOTES=$(gh api \
              --method POST \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              /repos/${{ github.repository }}/releases/generate-notes \
              -f tag_name=${{ github.ref_name }} | jq -r .body)
          else
            NOTES=$(gh api \
              --method POST \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              /repos/${{ github.repository }}/releases/generate-notes \
              -f tag_name=${{ github.ref_name }} \
              -f previous_tag_name=${{ env.PREVIOUS_TAG }} | jq -r .body)
          fi
          echo "NOTES<<EOF" >> $GITHUB_ENV
          echo "$NOTES" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Replace placeholders in template
        env:
          VERSION: ${{ github.ref_name }}
          NOTES: ${{ env.NOTES }}
        run: |
          python3 -c '
          import os
          with open(".github/release-template.md", "r") as f:
              template = f.read()
          version = os.environ.get("VERSION", "")
          notes = os.environ.get("NOTES", "")
          output = template.replace("{VERSION}", version).replace("{CHANGES}", notes)
          with open("release-notes.md", "w") as f:
              f.write(output)
          '

      - name: Create release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create ${{ github.ref_name }} --title "${{ github.ref_name }}" -F release-notes.md
